# Notification Flow Design - Conceptual

This document outlines how to configure notification steps within an n8n workflow, focusing on Slack and WhatsApp (via Twilio or a similar HTTP API-based service).

## Objective
To send timely and informative messages to the user about trading decisions, errors, or summaries generated by the n8n-QuantBot.

## 1. Slack Notification

*   **n8n Node**: `n8n-nodes-base.slack`
*   **Authentication**:
    *   Typically uses a "Slack Webhook URL".
    *   Store this URL securely in n8n credentials or as an environment variable (e.g., `{{$env.SLACK_WEBHOOK_URL}}`).
*   **Configuration**:
    *   **Webhook URL**: Parameter in the Slack node, pointing to your environment variable or credential.
    *   **Message Text**:
        *   Can be static text or dynamically generated using expressions based on previous node outputs.
        *   Example:
            ```
            Trading Alert: {{ $json["Strategy Combiner Agent Output"]["action"] }}
            Symbol: {{ $json["Data Fetch Agent Output"]["symbol"] }}
            Reason: Forecast {{ $json["Forecasting Agent Output"]["trend"] }} & News Sentiment {{ $json["Sentiment Analysis Agent Output"]["sentiment"] }}.
            Confirm trade: {{ $json["Manual Approval Agent Output"]["approval_link"] }} (if applicable)
            ```
        *   Supports Markdown for formatting.
    *   **Channel (Optional)**: If the webhook is not pre-configured for a specific channel, you might be able to specify it.
    *   **Username/Icon (Optional)**: Customize the bot's appearance in Slack.
*   **Use Cases**:
    *   Sending trade execution summaries.
    *   Notifying about buy/sell signals from the Strategy Combiner.
    *   Alerting on errors within the workflow.
    *   Sending daily/weekly performance summaries.

## 2. WhatsApp Notification (via HTTP Request - e.g., Twilio)

Since n8n might not have a dedicated WhatsApp node that works universally without a business provider, using the `n8n-nodes-base.httpRequest` node to interact with a WhatsApp Business API provider (like Twilio, Vonage, etc.) is a common approach.

*   **n8n Node**: `n8n-nodes-base.httpRequest`
*   **Prerequisites**:
    *   An account with a WhatsApp Business API provider (e.g., Twilio).
    *   A registered WhatsApp sender number.
    *   API credentials from the provider (Account SID, Auth Token for Twilio).
*   **Authentication**:
    *   Typically Basic Auth (Username/Password where Username is Account SID and Password is Auth Token for Twilio) or Bearer Token.
    *   Store credentials securely in n8n or as environment variables:
        *   `{{$env.TWILIO_ACCOUNT_SID}}`
        *   `{{$env.TWILIO_AUTH_TOKEN}}`
        *   `{{$env.TWILIO_WHATSAPP_FROM_NUMBER}}` (Your Twilio WhatsApp number)
*   **Configuration (Example for Twilio API)**:
    *   **Method**: `POST`
    *   **URL**: `https://api.twilio.com/2010-04-01/Accounts/{{$env.TWILIO_ACCOUNT_SID}}/Messages.json`
    *   **Authentication**: Basic
        *   User: `{{$env.TWILIO_ACCOUNT_SID}}`
        *   Password: `{{$env.TWILIO_AUTH_TOKEN}}`
    *   **Body Type**: `Form URL Encoded`
    *   **Body Parameters**:
        *   `To`: `whatsapp:{{ $json["user_phone_number"] }}` (User's WhatsApp number, including country code, e.g., +12345678900. This should come from an earlier step or config).
        *   `From`: `whatsapp:{{ $env.TWILIO_WHATSAPP_FROM_NUMBER }}`
        *   `Body`: Dynamic message content, similar to Slack.
            ```
            n8n-QuantBot Alert:
            Action: {{ $json["Strategy Output"]["action"] }}
            Symbol: {{ $json["Stock Info"]["symbol"] }}
            Details: Prediction - {{ $json["Forecast"]["prediction"] }}, Sentiment - {{ $json["Sentiment"]["score"] }}
            ```
*   **Considerations for WhatsApp**:
    *   **Templates**: For unsolicited notifications (first message or messages outside a 24-hour window), WhatsApp often requires pre-approved message templates.
    *   **Cost**: Sending WhatsApp messages via API providers usually incurs costs.
    *   **Rate Limits**: Be aware of any sending rate limits imposed by the provider.
*   **Use Cases**: Similar to Slack, but often preferred for more personal or urgent alerts.

## General Best Practices for Notifications
*   **Clarity**: Messages should be clear, concise, and provide all necessary information.
*   **Actionability**: If a response is needed (e.g., manual approval), include clear instructions or links.
*   **Error Handling**: Have a separate notification path for critical workflow errors, possibly using a different channel or method to ensure visibility.
*   **User Preferences**: Ideally, allow users to configure their preferred notification channels and types of alerts. (This is an advanced feature, not typically part of the initial setup).
*   **JSON Parsing**: Ensure the data being fed into the message content (e.g., `{{ $json["Node Name"]["output_key"] }}`) correctly accesses the desired information from previous nodes. Use the n8n "Expression Editor" to test these paths.
